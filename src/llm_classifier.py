"""
LLM ë¶„ë¥˜ ëª¨ë“ˆ
Qwen3 ë˜ëŠ” Databricks GPT-OSS ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ ë„ë©”ì¸ ë¶„ë¥˜ ìˆ˜í–‰
"""

import requests
import logging
from typing import List, Tuple, Optional, Dict, Any
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry

# 13ê°œ LLM ì¹œí™”ì  ë„ë©”ì¸ê³¼ 21ê°œ ê¸°ì¡´ ë„ë©”ì¸ ê°„ì˜ ë§¤í•‘
# ê° ìƒìœ„ ë„ë©”ì¸(13ê°œ)ì— í¬í•¨ë˜ëŠ” ì„¸ë¶€ ë„ë©”ì¸(21ê°œ) ëª©ë¡
HIERARCHICAL_DOMAIN_MAPPING = {
    "ê³„ì•½ ë° ê³ ê° ì •ë³´": ["ê³„ì•½ì •ë³´", "ê³ ê°ì •ë³´", "ëª…ì˜ë³€ê²½"],
    "ë³´í—˜ê¸ˆ ì²­êµ¬ ë° ë³´ì¥": ["ë³´í—˜ê¸ˆ ë³´ì¥", "ì œì§€ê¸‰"],
    "ë³´í—˜ë£Œ ë‚©ì… ë° ê´€ë¦¬": ["ë³´í—˜ë£Œë‚©ì…"],
    "ê³„ì•½ í•´ì§€ ë° ì·¨ì†Œ": ["ê³„ì•½í•´ì§€"],
    "ì¦ëª…ì„œ ë° ì•ˆë‚´ì¥": ["ì¦ëª…ì„œ ì•ˆë‚´ì¥"],
    "ëŒ€ì¶œ": ["ëŒ€ì¶œ"],
    "ì—°ê¸ˆ ë° ìì‚° ìš´ìš©": ["ì—°ê¸ˆ", "ë³€ì•¡ í€ë“œ", "ë¶„ë¦¬ë³´ê´€"],
    "í—¬ìŠ¤ì¼€ì–´ ë° ë¶€ê°€ì„œë¹„ìŠ¤": ["í—¬ìŠ¤ì¼€ì–´ì„œë¹„ìŠ¤", "ë°”ì´íƒˆë¦¬í‹°"],
    "ì±„ë„ ë° ì‹œìŠ¤í…œ ì´ìš©": ["ì±„ë„ í‘œê¸° ì½”ë“œ"],
    "ë²•ë¥  ë° ì„¸ë¬´": ["ë²• ì œë„", "ì±„ê¶Œì••ë¥˜ ì§ˆê¶Œì„¤ì •"],
    "ë¯¼ì› ë° ë¶ˆë§Œ": ["ë¯¼ì›"],
    "ì„¤ê³„ì‚¬ ë° ëª¨ì§‘": ["ì„¤ê³„ì‚¬"],
    "ì‹ ê³„ì•½ ë° í•´í”¼ì½œ": ["ì‹ ê³„ì•½ ë¯¸ê²°", "í•´í”¼ì½œ"],
}


class LLMClassifier:
    """LLMì„ ì‚¬ìš©í•œ ë„ë©”ì¸ ë¶„ë¥˜ê¸° (Connection Pool ì§€ì›)"""

    def __init__(
        self,
        provider: str,
        config: Dict[str, Any],
        domains: List[str],
        timeout: int = 30,
    ):
        """
        Args:
            provider: LLM ì œê³µì ('qwen3' ë˜ëŠ” 'databricks')
            config: LLM ì„¤ì • ë”•ì…”ë„ˆë¦¬
            domains: ë„ë©”ì¸ ëª©ë¡
            timeout: API íƒ€ì„ì•„ì›ƒ (ì´ˆ)
        """
        self.provider = provider.lower()
        self.config = config
        self.domains = domains
        self.timeout = timeout

        # í‚¤ì›Œë“œ ê·œì¹™ ì ìš© ì—¬ë¶€ (.envì—ì„œ ë¡œë“œ, ê¸°ë³¸ê°’ True)
        import os

        self.enable_keyword_rules = (
            os.getenv("ENABLE_KEYWORD_RULES", "true").lower() == "true"
        )

        # ì‹¤í—˜10 ëª¨ë“œ: LLM ì¹œí™”ì  ë„ë©”ì¸ ì¬êµ¬ì„± ì‚¬ìš© ì—¬ë¶€ (.envì—ì„œ ë¡œë“œ, ê¸°ë³¸ê°’ False)
        self.use_hierarchical_domains = (
            os.getenv("USE_HIERARCHICAL_DOMAINS", "false").lower() == "true"
        )

        # Connection Poolì„ ìœ„í•œ Session ê°ì²´ ìƒì„±
        self.session = requests.Session()

        # Retry ì „ëµ ì„¤ì •
        retry_strategy = Retry(
            total=10,
            backoff_factor=2,
            status_forcelist=[429, 500, 502, 503, 504],
            allowed_methods=["POST", "GET"],
        )

        # HTTPAdapterë¥¼ ì‚¬ìš©í•˜ì—¬ Connection Pool ì„¤ì •
        adapter = HTTPAdapter(
            max_retries=retry_strategy, pool_connections=10, pool_maxsize=10
        )

        self.session.mount("http://", adapter)
        self.session.mount("https://", adapter)

    def _apply_keyword_rules(self, question: str) -> Optional[str]:
        """
        í‚¤ì›Œë“œ ê¸°ë°˜ ê°•ì œ ë¶„ë¥˜ ê·œì¹™ ì ìš© (Experiment 9)
        í™•ì‹¤í•œ íŒ¨í„´ë§Œ ì ìš©í•˜ê³ , ë¬¸ë§¥ íŒë‹¨ì´ í•„ìš”í•œ ëª¨í˜¸í•œ í‚¤ì›Œë“œëŠ” ì œê±°í•¨.

        Args:
            question: ì§ˆë¬¸ í…ìŠ¤íŠ¸

        Returns:
            ë§¤ì¹­ëœ ë„ë©”ì¸ ë˜ëŠ” None
        """
        q = question.replace(" ", "")  # ë„ì–´ì“°ê¸° ë¬´ì‹œ

        # 1. ê³„ì•½í•´ì§€ (ì œì§€ê¸‰ í˜¼ë™ ë°©ì§€) - ì²­ì•½ì² íšŒëŠ” ë¬´ì¡°ê±´ í•´ì§€
        if "ì²­ì•½ì² íšŒ" in q or "ì²­ì•½ì·¨ì†Œ" in q:
            return "ê³„ì•½í•´ì§€"

        # 2. ë²• ì œë„ (ë³´í—˜ê¸ˆ/í•´ì§€ í˜¼ë™ ë°©ì§€) - ì†Œë©¸ì‹œíš¨ëŠ” ë²•ì  ê¸°ê°„ ë¬¸ì œ
        if "ì†Œë©¸ì‹œíš¨" in q:
            return "ë²• ì œë„"

        # 3. ì±„ë„ í‘œê¸° ì½”ë“œ (ë³´í—˜ë£Œë‚©ì… í˜¼ë™ ë°©ì§€) - ì‹œìŠ¤í…œ í‘œê¸° ê´€ë ¨
        if "RTB" in q or "EWS" in q or "í†µì¥í‘œê¸°" in q or "ì ìš”" in q:
            return "ì±„ë„ í‘œê¸° ì½”ë“œ"

        # 4. ëŒ€ì¶œ (ëª…í™•í•œ ìƒí’ˆëª…)
        if "ì•½ê´€ëŒ€ì¶œ" in q or "ë³´í—˜ê³„ì•½ëŒ€ì¶œ" in q or "APL" in q or "ìë™ëŒ€ì¶œë‚©ì…" in q:
            return "ëŒ€ì¶œ"

        # ë‚©ì…ì¤‘ì§€, ë¶€í™œ, ì¦ëª…ì„œ ë“±ì€ ë¬¸ë§¥ì— ë”°ë¼ ë„ë©”ì¸ì´ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆì–´ LLMì— ìœ„ì„

        return None

    def classify(
        self, question: str
    ) -> Tuple[Optional[str], Optional[str], Optional[str]]:
        """
        ì§ˆë¬¸ì„ ë¶„ì„í•˜ì—¬ ë„ë©”ì¸ ë¶„ë¥˜

        Args:
            question: ë¶„ë¥˜í•  ì§ˆë¬¸

        Returns:
            (ë¶„ë¥˜ëœ ë„ë©”ì¸, ë¶„ë¥˜ ì˜ê²¬, ì˜ê²¬ êµ¬ë¶„) íŠœí”Œ
        """
        # 1. ê·œì¹™ ê¸°ë°˜ ë¶„ë¥˜ ìš°ì„  ì ìš© (ì˜µì…˜ì´ ì¼œì ¸ìˆì„ ë•Œë§Œ)
        if self.enable_keyword_rules:
            rule_domain = self._apply_keyword_rules(question)
            if rule_domain:
                logging.info(f"Rule-based ë¶„ë¥˜ ì ìš©: {question} -> {rule_domain}")
                return rule_domain, "í‚¤ì›Œë“œ ê·œì¹™ì— ì˜í•œ ê°•ì œ ë¶„ë¥˜", "ì •í™•íˆ ë¶„ë¥˜ë¨"

        # 2. LLM ë¶„ë¥˜ ìˆ˜í–‰
        try:
            prompt = self._build_prompt(question)
            response, error_msg = self._call_llm_api(prompt)

            if response is not None:
                domain, opinion, opinion_category = self._parse_response(response)
                return domain, opinion, opinion_category
            else:
                # API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ìƒì„¸ ì˜¤ë¥˜ ë©”ì‹œì§€ ë°˜í™˜
                return None, f"LLM API í˜¸ì¶œ ì‹¤íŒ¨: {error_msg}", "ê¸°íƒ€ì˜ê²¬"

        except Exception as e:
            logging.error(f"ë¶„ë¥˜ ì¤‘ ì˜ˆì™¸ ë°œìƒ: {e}")
            import traceback

            logging.debug(f"ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:\n{traceback.format_exc()}")
            return None, f"ì˜ˆì™¸ ë°œìƒ: {str(e)}", "ê¸°íƒ€ì˜ê²¬"

    def _build_hierarchical_prompt(self, question: str) -> str:
        """
        ê³„ì¸µì  ë„ë©”ì¸ ë¶„ë¥˜ í”„ë¡¬í”„íŠ¸ ìƒì„± (ì‹¤í—˜10)
        13ê°œ LLM ì¹œí™”ì  ë„ë©”ì¸ìœ¼ë¡œ ë¶„ë¥˜í•œ í›„, ì„¸ë¶€ ë„ë©”ì¸(21ê°œ)ì„ ì„ íƒ

        Args:
            question: ë¶„ë¥˜í•  ì§ˆë¬¸

        Returns:
            ìƒì„±ëœ í”„ë¡¬í”„íŠ¸
        """
        prompt = f"""ë‹¹ì‹ ì€ ë³´í—˜ ê³ ê° ë¬¸ì˜ ë¶„ë¥˜ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

ã€ëª©í‘œã€‘ ì‚¬ìš©ìì˜ ì§ˆë¬¸ì„ ë¶„ì„í•˜ì—¬ ì ì ˆí•œ ë„ë©”ì¸ìœ¼ë¡œ ë¶„ë¥˜í•˜ì„¸ìš”.

ì§ˆë¬¸: {question}

=== ë„ë©”ì¸ ë¶„ë¥˜ ë°©ì‹ (2ë‹¨ê³„) ===

1ë‹¨ê³„: ë¨¼ì € ìƒìœ„ ë„ë©”ì¸(13ê°œ ì¤‘ 1ê°œ)ì„ ì„ íƒí•˜ì„¸ìš”.
2ë‹¨ê³„: ìƒìœ„ ë„ë©”ì¸ì— ì†í•˜ëŠ” ì„¸ë¶€ ë„ë©”ì¸ì„ ì„ íƒí•˜ì„¸ìš”.

=== ìƒìœ„ ë„ë©”ì¸ ì •ì˜ (13ê°œ) ===

**1. ê³„ì•½ ë° ê³ ê° ì •ë³´**
- í¬í•¨ ë„ë©”ì¸: ê³„ì•½ì •ë³´, ê³ ê°ì •ë³´, ëª…ì˜ë³€ê²½
- ë¬¸ì„œ ë‚´ìš©: ê³„ì•½ ìƒíƒœ ì¡°íšŒ/ë³€ê²½(ë¶€í™œ, ê°ì•¡, ì‹¤íš¨), ê³ ê°ì˜ ì‹ ìƒ ë³€ê²½(ì£¼ì†Œ, ì—°ë½ì²˜), ê³„ì•½ì˜ ì£¼ì²´ ë³€ê²½(ê³„ì•½ì, ìˆ˜ìµì, ì§€ì •ëŒ€ë¦¬ì¸)
- ì´ìœ : "ë‚´ ì •ë³´/ê³„ì•½ì„ ë°”ê¾¸ê³  ì‹¶ë‹¤"ëŠ” ë™ì¼í•œ ì˜ë„ì´ë©°, ì²˜ë¦¬ ë¶€ì„œë‚˜ ì ˆì°¨ê°€ ìœ ì‚¬í•¨
- ì„¸ë¶€ ë¶„ë¥˜ ê¸°ì¤€:
  â€¢ ê³„ì•½ì •ë³´: ê³„ì•½ ìƒíƒœ(ë¶€í™œ, ê°ì•¡, ì‹¤íš¨, ì§ë¬´ì§ì¢…), ê±´ê°•ì¸/ë¹„í¡ì—° í• ì¸, ì²­ì•½ì„œ
  â€¢ ê³ ê°ì •ë³´: ì£¼ì†Œ, ì—°ë½ì²˜, ë§ˆì¼€íŒ… ë™ì˜, ê°œì¸ì •ë³´
  â€¢ ëª…ì˜ë³€ê²½: ê³„ì•½ì/ìˆ˜ìµì ë³€ê²½, ëª…ì˜ ì •ì •, ì§€ì •ëŒ€ë¦¬ì²­êµ¬ì¸

**2. ë³´í—˜ê¸ˆ ì²­êµ¬ ë° ë³´ì¥**
- í¬í•¨ ë„ë©”ì¸: ë³´í—˜ê¸ˆ ë³´ì¥, ì œì§€ê¸‰
- ë¬¸ì„œ ë‚´ìš©: ì§ˆë³‘/ìƒí•´ ë³´ì¥ ë²”ìœ„, ì²­êµ¬ ìê²©, ì²­êµ¬ í•„ìš” ì„œë¥˜, ì‹¬ì‚¬ ê¸°ì¤€, ì§€ê¸‰ ì ˆì°¨
- ì´ìœ : "ëˆì„ ë°›ì„ ìˆ˜ ìˆëŠ”ê°€(ë³´ì¥)"ì™€ "ëˆì„ ì–´ë–»ê²Œ ë°›ëŠ”ê°€(ì²­êµ¬)"ëŠ” ì‚¬ìš©ì ì…ì¥ì—ì„œ í•˜ë‚˜ì˜ íë¦„ì„
- ì„¸ë¶€ ë¶„ë¥˜ ê¸°ì¤€:
  â€¢ ë³´í—˜ê¸ˆ ë³´ì¥: ë³´ì¥ ì—¬ë¶€, ì§„ë‹¨ì½”ë“œ, ìˆ˜ìˆ ëª…, ì²­êµ¬ ì¡°ê±´
  â€¢ ì œì§€ê¸‰: ì§€ê¸‰ ì ˆì°¨, ì§€ê¸‰ ë°©ë²•, ìˆ˜ìµì í™•ì¸, ì²­êµ¬ ì„œë¥˜ ì ‘ìˆ˜

**3. ë³´í—˜ë£Œ ë‚©ì… ë° ê´€ë¦¬**
- í¬í•¨ ë„ë©”ì¸: ë³´í—˜ë£Œë‚©ì…
- ë¬¸ì„œ ë‚´ìš©: ë³´í—˜ë£Œ ë‚©ë¶€ ë°©ë²•(ìë™ì´ì²´, ì¹´ë“œ), ë‚©ì… ì¼ì ë³€ê²½, ë¯¸ë‚© ì²˜ë¦¬, ë‚©ì… ì¤‘ì§€/ìœ ì˜ˆ
- ì´ìœ : "ëˆì„ ë‚´ëŠ” ê²ƒ"ì— ëŒ€í•œ ëª¨ë“  í”„ë¡œì„¸ìŠ¤

**4. ê³„ì•½ í•´ì§€ ë° ì·¨ì†Œ**
- í¬í•¨ ë„ë©”ì¸: ê³„ì•½í•´ì§€
- ë¬¸ì„œ ë‚´ìš©: í•´ì§€ ì‹ ì²­, í•´ì§€í™˜ê¸‰ê¸ˆ ì¡°íšŒ/ìˆ˜ë ¹, ì²­ì•½ì² íšŒ(ê°€ì… ì·¨ì†Œ), í’ˆì§ˆë³´ì¦í•´ì§€
- ì´ìœ : ê³„ì•½ì„ ëë‚´ëŠ” í–‰ìœ„ëŠ” ë‹¤ë¥¸ ìœ ì§€/ê´€ë¦¬ ì—…ë¬´ì™€ ëª…í™•íˆ êµ¬ë¶„ë¨

**5. ì¦ëª…ì„œ ë° ì•ˆë‚´ì¥**
- í¬í•¨ ë„ë©”ì¸: ì¦ëª…ì„œ ì•ˆë‚´ì¥
- ë¬¸ì„œ ë‚´ìš©: ë³´í—˜ì¦ê¶Œ, ë‚©ì…ì¦ëª…ì„œ, ì†Œë“ê³µì œìš© ì„œë¥˜ ë“± ê°ì¢… "ì¢…ì´/PDF ë¬¸ì„œ" ë°œê¸‰
- ì´ìœ : ì‚¬ìš©ìê°€ "ì–´ë–¤ ì„œë¥˜ë¥¼ ë‹¬ë¼"ê³  í•  ë•Œ ì°¾ëŠ” ê³³

**6. ëŒ€ì¶œ**
- í¬í•¨ ë„ë©”ì¸: ëŒ€ì¶œ
- ë¬¸ì„œ ë‚´ìš©: ë³´í—˜ê³„ì•½ëŒ€ì¶œ ì‹ ì²­/ìƒí™˜, ì´ììœ¨, í•œë„, APL
- ì´ìœ : "ëˆì„ ë¹Œë¦¬ëŠ” ê²ƒ"ì€ ë³´í—˜ ê³ ìœ ì˜ ê¸°ëŠ¥ì´ ì•„ë‹ˆë¼ ë³„ë„ ê¸ˆìœµ ì„œë¹„ìŠ¤ ì„±ê²©ì„

**7. ì—°ê¸ˆ ë° ìì‚° ìš´ìš©**
- í¬í•¨ ë„ë©”ì¸: ì—°ê¸ˆ, ë³€ì•¡ í€ë“œ, ë¶„ë¦¬ë³´ê´€
- ë¬¸ì„œ ë‚´ìš©: ì—°ê¸ˆ ìˆ˜ë ¹ ê°œì‹œ/ë³€ê²½, ë³€ì•¡ í€ë“œ ë³€ê²½/ìˆ˜ìµë¥ , íœ´ë©´ ìì‚° ê´€ë¦¬
- ì´ìœ : ì¥ê¸°ì ì¸ ìì‚° ê´€ë¦¬ ë° ìš´ìš©ì— ê´€í•œ ë‚´ìš©
- ì„¸ë¶€ ë¶„ë¥˜ ê¸°ì¤€:
  â€¢ ì—°ê¸ˆ: ì—°ê¸ˆ ì „í™˜, ì—°ê¸ˆ ìˆ˜ë ¹
  â€¢ ë³€ì•¡ í€ë“œ: í€ë“œ ë³€ê²½, ìˆ˜ìµë¥ , íˆ¬ì
  â€¢ ë¶„ë¦¬ë³´ê´€: íœ´ë©´ ê³„ì•½, ë¶„ë¦¬ë³´ê´€

**8. í—¬ìŠ¤ì¼€ì–´ ë° ë¶€ê°€ì„œë¹„ìŠ¤**
- í¬í•¨ ë„ë©”ì¸: í—¬ìŠ¤ì¼€ì–´ì„œë¹„ìŠ¤, ë°”ì´íƒˆë¦¬í‹°
- ë¬¸ì„œ ë‚´ìš©: ê±´ê°•ê²€ì§„, ê±·ê¸° ë¦¬ì›Œë“œ, ì œíœ´ ì„œë¹„ìŠ¤, ì•± í™œìš©(ê±´ê°• ê´€ë ¨)
- ì´ìœ : ë³´í—˜ ê³„ì•½ ì™¸ì˜ í˜œíƒ ì„œë¹„ìŠ¤
- ì„¸ë¶€ ë¶„ë¥˜ ê¸°ì¤€:
  â€¢ í—¬ìŠ¤ì¼€ì–´ì„œë¹„ìŠ¤: ê±´ê°•ê²€ì§„, ê±´ê°•ìƒë‹´, ê±´ê°•í”ŒëŸ¬ìŠ¤
  â€¢ ë°”ì´íƒˆë¦¬í‹°: ë°”ì´íƒˆë¦¬í‹° ë©¤ë²„ì‹­, ë“±ê¸‰, ë¦¬ì›Œë“œ, ê±·ê¸°

**9. ì±„ë„ ë° ì‹œìŠ¤í…œ ì´ìš©**
- í¬í•¨ ë„ë©”ì¸: ì±„ë„ í‘œê¸° ì½”ë“œ
- ë¬¸ì„œ ë‚´ìš©: í™ˆí˜ì´ì§€/ì•± ë¡œê·¸ì¸, ì˜¤ë¥˜ í•´ê²°, ARS ì´ìš©ë²•, í†µì¥ ì ìš” ì½”ë“œ í•´ì„
- ì´ìœ : "ì–´ë””ì„œ/ì–´ë–»ê²Œ ì´ìš©í•˜ëŠ”ê°€"ì— ëŒ€í•œ ê¸°ìˆ ì  ì§€ì›

**10. ë²•ë¥  ë° ì„¸ë¬´**
- í¬í•¨ ë„ë©”ì¸: ë²• ì œë„, ì±„ê¶Œì••ë¥˜ ì§ˆê¶Œì„¤ì •
- ë¬¸ì„œ ë‚´ìš©: ì„¸ê¸ˆ, ìƒì†, ì••ë¥˜, í•´ì™¸ ê±°ì£¼ì(FATCA) ë“± ë²•ì  ê·œì œ ë° ì œë„ ì„¤ëª…
- ì´ìœ : ìƒí’ˆê³¼ ë¬´ê´€í•œ ì¼ë°˜ì ì¸ ë²•ì  ë¬¸ì˜
- ì„¸ë¶€ ë¶„ë¥˜ ê¸°ì¤€:
  â€¢ ë²• ì œë„: ë¹„ê³¼ì„¸, ì„¸ê¸ˆ, ì„±ë…„í›„ê²¬, ì¬ì™¸êµ­ë¯¼, ìƒì†
  â€¢ ì±„ê¶Œì••ë¥˜ ì§ˆê¶Œì„¤ì •: ë²•ì› ì••ë¥˜, ì§ˆê¶Œ ì„¤ì •

**11. ë¯¼ì› ë° ë¶ˆë§Œ**
- í¬í•¨ ë„ë©”ì¸: ë¯¼ì›
- ë¬¸ì„œ ë‚´ìš©: ë¶ˆë§Œ ì ‘ìˆ˜ ì ˆì°¨, ì²˜ë¦¬ ê³¼ì •
- ì´ìœ : íŠ¹ìˆ˜í•œ í”„ë¡œì„¸ìŠ¤

**12. ì„¤ê³„ì‚¬ ë° ëª¨ì§‘**
- í¬í•¨ ë„ë©”ì¸: ì„¤ê³„ì‚¬
- ë¬¸ì„œ ë‚´ìš©: ì„¤ê³„ì‚¬ ì •ë³´, ìˆ˜ìˆ˜ë£Œ, ë‹´ë‹¹ì ë³€ê²½
- ì´ìœ : ì˜ì—… ê´€ë ¨ ë‚´ìš©

**13. ì‹ ê³„ì•½ ë° í•´í”¼ì½œ**
- í¬í•¨ ë„ë©”ì¸: ì‹ ê³„ì•½ ë¯¸ê²°, í•´í”¼ì½œ
- ë¬¸ì„œ ë‚´ìš©: ì²­ì•½ í›„ ìŠ¹ë‚™ ì „ ë‹¨ê³„, ì™„ì „íŒë§¤ ëª¨ë‹ˆí„°ë§, ì‹¬ì‚¬ ì§„í–‰
- ì´ìœ : ê°€ì… ì§í›„ì˜ í•´í”¼ì½œ ë° ì‹¬ì‚¬ ëŒ€ê¸° ìƒíƒœ ê´€ë¦¬
- ì„¸ë¶€ ë¶„ë¥˜ ê¸°ì¤€:
  â€¢ ì‹ ê³„ì•½ ë¯¸ê²°: ì²­ì•½ í›„ ìŠ¹ë‚™ ì „, ì‹¬ì‚¬, ë³´ì™„, ë¶€ë‹´ë³´
  â€¢ í•´í”¼ì½œ: ì™„ì „íŒë§¤ ëª¨ë‹ˆí„°ë§, í•´í”¼ì½œ ì „í™”

=== ë¶„ë¥˜ ì˜ˆì‹œ ===

ì§ˆë¬¸ 1: "ì²­ì•½ì² íšŒë¥¼ ì´ë©”ì¼ë¡œ ì ‘ìˆ˜í•  ìˆ˜ ìˆë‚˜ìš”?"
ìƒìœ„ë„ë©”ì¸: ê³„ì•½ í•´ì§€ ë° ì·¨ì†Œ
ì„¸ë¶€ë„ë©”ì¸: ê³„ì•½í•´ì§€
ì´ìœ : ì²­ì•½ì² íšŒëŠ” ê³„ì•½ì„ ë¬´íš¨í™”í•˜ëŠ” í–‰ìœ„ë¡œ ê³„ì•½í•´ì§€ì— ì†í•¨

ì§ˆë¬¸ 2: "ë‚©ì…ì£¼ê¸°ë¥¼ ì›”ë‚©ì—ì„œ ì—°ë‚©ìœ¼ë¡œ ë°”ê¾¸ê³  ì‹¶ì–´ìš”."
ìƒìœ„ë„ë©”ì¸: ê³„ì•½ ë° ê³ ê° ì •ë³´
ì„¸ë¶€ë„ë©”ì¸: ê³„ì•½ì •ë³´
ì´ìœ : ë‚©ì…ì£¼ê¸°ëŠ” ê³„ì•½ì˜ ì¡°ê±´ì„ ë³€ê²½í•˜ëŠ” ê²ƒì´ë¯€ë¡œ ê³„ì•½ì •ë³´ì— í•´ë‹¹

ì§ˆë¬¸ 3: "ìë™ì´ì²´ ê³„ì¢Œë¥¼ ë°”ê¾¸ê³  ì‹¶ì–´ìš”."
ìƒìœ„ë„ë©”ì¸: ë³´í—˜ë£Œ ë‚©ì… ë° ê´€ë¦¬
ì„¸ë¶€ë„ë©”ì¸: ë³´í—˜ë£Œë‚©ì…
ì´ìœ : ë³´í—˜ë£Œ ë‚©ì… ìˆ˜ë‹¨ ë³€ê²½

ì§ˆë¬¸ 4: "ê³„ì•½ìë¥¼ ë‚¨í¸ìœ¼ë¡œ ë³€ê²½í•˜ë ¤ë©´?"
ìƒìœ„ë„ë©”ì¸: ê³„ì•½ ë° ê³ ê° ì •ë³´
ì„¸ë¶€ë„ë©”ì¸: ëª…ì˜ë³€ê²½
ì´ìœ : ê³„ì•½ì˜ ì£¼ì²´(ê³„ì•½ì)ë¥¼ ë³€ê²½í•˜ëŠ” ê²ƒ

ì§ˆë¬¸ 5: "ë°±ë‚´ì¥ ìˆ˜ìˆ  ë³´ì¥ë˜ë‚˜ìš”?"
ìƒìœ„ë„ë©”ì¸: ë³´í—˜ê¸ˆ ì²­êµ¬ ë° ë³´ì¥
ì„¸ë¶€ë„ë©”ì¸: ë³´í—˜ê¸ˆ ë³´ì¥
ì´ìœ : íŠ¹ì • ìˆ˜ìˆ ì˜ ë³´ì¥ ì—¬ë¶€ë¥¼ ë¬»ëŠ” ì§ˆë¬¸

ì§ˆë¬¸ 6: "ë³´í—˜ê¸ˆ ì²­êµ¬ ì„œë¥˜ ì–´ë””ì— ì œì¶œí•˜ë‚˜ìš”?"
ìƒìœ„ë„ë©”ì¸: ë³´í—˜ê¸ˆ ì²­êµ¬ ë° ë³´ì¥
ì„¸ë¶€ë„ë©”ì¸: ì œì§€ê¸‰
ì´ìœ : ì²­êµ¬ ì„œë¥˜ ì ‘ìˆ˜ ë°©ë²•ì— ëŒ€í•œ ì§ˆë¬¸

=== ì˜ê²¬ êµ¬ë¶„ ì¹´í…Œê³ ë¦¬ ===
1. "ì •í™•íˆ ë¶„ë¥˜ë¨"
2. "Ground Truthê°€ ì˜ëª»ë¨"
3. "Questionì´ ëª¨í˜¸í•¨"
4. "ë§ëŠ” ë„ë©”ì¸ì´ ì—†ìŒ"
5. "ê¸°íƒ€ì˜ê²¬"

=== ì‘ë‹µ í˜•ì‹ ===
ìƒìœ„ë„ë©”ì¸: [13ê°œ ë„ë©”ì¸ ì¤‘ í•˜ë‚˜]
ì„¸ë¶€ë„ë©”ì¸: [í•´ë‹¹ ìƒìœ„ë„ë©”ì¸ì— ì†í•˜ëŠ” ì„¸ë¶€ ë„ë©”ì¸ ì¤‘ í•˜ë‚˜]
ì´ìœ : [ë‹¨ê³„ë³„ íŒë‹¨ ê·¼ê±°]
ì˜ê²¬êµ¬ë¶„: [ìœ„ 5ê°€ì§€ ì¤‘ í•˜ë‚˜]
"""
        return prompt

    def _build_prompt(self, question: str) -> str:
        """
        LLM í”„ë¡¬í”„íŠ¸ ìƒì„± (ë„ë©”ì¸ ì •ì˜ í¬í•¨)

        Args:
            question: ë¶„ë¥˜í•  ì§ˆë¬¸

        Returns:
            ìƒì„±ëœ í”„ë¡¬í”„íŠ¸
        """
        # ì‹¤í—˜10 ëª¨ë“œ: ê³„ì¸µì  ë„ë©”ì¸ ì‚¬ìš©
        if self.use_hierarchical_domains:
            return self._build_hierarchical_prompt(question)

        # ê¸°ì¡´ ë°©ì‹ (21ê°œ ë„ë©”ì¸)
        prompt = f"""ë‹¹ì‹ ì€ RAG(ê²€ìƒ‰ ì¦ê°• ìƒì„±)ë¥¼ ìœ„í•œ ë¬¸ì„œ ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

ã€ëª©í‘œã€‘ ì‚¬ìš©ìì˜ ì§ˆë¬¸ì„ ë¶„ì„í•˜ì—¬, ë‹µë³€ì„ ì°¾ì„ ìˆ˜ ìˆëŠ” "ë¬¸ì„œ ì¹´í…Œê³ ë¦¬"ë¥¼ ì„ íƒí•˜ì„¸ìš”.
- ì§ˆë¬¸ì˜ ì˜ë„ë³´ë‹¤ëŠ” "ì–´ëŠ ë§¤ë‰´ì–¼(ë¬¸ì„œ)ì„ í¼ì³ì•¼ í•˜ëŠ”ê°€"ë¥¼ ìƒê°í•˜ì‹­ì‹œì˜¤.

ì§ˆë¬¸: {question}

=== ë„ë©”ì¸ ê·¸ë£¹ ê°€ì´ë“œ (ë¨¼ì € ìƒê°í•˜ì„¸ìš”) ===

1. [ìê¸ˆ íë¦„] ëˆê³¼ ê´€ë ¨ëœ ì§ˆë¬¸ì¸ê°€ìš”?
   - ëˆì„ ë‚´ëŠ” ê²ƒ(ë‚©ì…) -> [ë³´í—˜ë£Œë‚©ì…]
   - ëˆì„ ë°›ëŠ” ê²ƒ(ìˆ˜ë ¹) -> [ì œì§€ê¸‰] (ë‹¨, í•´ì§€í™˜ê¸‰ê¸ˆ/ì²­ì•½ì² íšŒëŠ” [ê³„ì•½í•´ì§€])
   - ëˆì„ ë¹Œë¦¬ëŠ” ê²ƒ(ëŒ€ì¶œ) -> [ëŒ€ì¶œ]

2. [ê³„ì•½ ìƒíƒœ] ê³„ì•½ì„ ë³€ê²½í•˜ê±°ë‚˜ ëë‚´ëŠ” ì§ˆë¬¸ì¸ê°€ìš”?
   - ê³„ì•½ì„ ì•„ì˜ˆ ëë‚´ëŠ” ê²ƒ -> [ê³„ì•½í•´ì§€] (ì²­ì•½ì² íšŒ í¬í•¨)
   - ê³„ì•½ì„ ìœ ì§€í•˜ë©´ì„œ ì¡°ê±´ë§Œ ë³€ê²½(ë¶€í™œ, ê°ì•¡, ì£¼ê¸°ë³€ê²½) -> [ê³„ì•½ì •ë³´]
   - ê³„ì•½ì˜ ì£¼ì¸/ëŒ€ìƒ ë³€ê²½(ëª…ì˜) -> [ëª…ì˜ë³€ê²½]

3. [ì„œë¥˜/ì¦ëª…] ì„œë¥˜ê°€ í•„ìš”í•œê°€ìš”?
   - ì œì¶œìš© ì¦ëª…ì„œ ë°œê¸‰ -> [ì¦ëª…ì„œ ì•ˆë‚´ì¥]
   - ë‹¨ìˆœ í™•ì¸ìš© ì„œë¥˜(ì²­ì•½ì„œ ë“±) -> [ê³„ì•½ì •ë³´]
   - ì²­êµ¬/ì‹ ì²­ì„ ìœ„í•œ êµ¬ë¹„ì„œë¥˜ -> í•´ë‹¹ ì—…ë¬´ ë„ë©”ì¸ ([ì œì§€ê¸‰], [ëª…ì˜ë³€ê²½] ë“±)

=== ë¬¸ì„œ ì¹´í…Œê³ ë¦¬ ì •ì˜ (ì´ 21ê°œ) ===

1. ë³´í—˜ê¸ˆ ë³´ì¥
   ğŸ“ ë¬¸ì„œ ë‚´ìš©: ì§ˆë³‘/ìˆ˜ìˆ /ìƒí•´ ë³´ì¥ ì—¬ë¶€, ì§„ë‹¨ì½”ë“œ(ICD), ìˆ˜ìˆ ëª… ì„¤ëª…, 'ì²­êµ¬ ê°€ëŠ¥ ì¡°ê±´', íŠ¹ì • ì§ˆë³‘ì˜ ì²­êµ¬ í•„ìš” ì„œë¥˜
   âœ… ë‹µë³€ ê°€ëŠ¥: "ë°±ë‚´ì¥ ìˆ˜ìˆ  ë³´ì¥ë˜ë‚˜ìš”?", "C50 ì½”ë“œê°€ ë­”ê°€ìš”?", "ì‹¤ì† í†µì› ì²­êµ¬ ì‹œ í•„ìš”í•œ ë³‘ì› ì„œë¥˜ëŠ”?"(ë³´ì¥ ì¡°ê±´ í™•ì¸)
   âŒ ë‹µë³€ ë¶ˆê°€: "ì§€ê¸‰ ê³„ì¢Œ ë³€ê²½?"(ì œì§€ê¸‰), "ì¼ë°˜ì ì¸ ì²­êµ¬ ì„œë¥˜ ì ‘ìˆ˜ ë°©ë²•?"(ì œì§€ê¸‰)
   âš ï¸ í•µì‹¬: ì˜ë£Œ ìš©ì–´, ì§ˆë³‘ëª…, ìˆ˜ìˆ ëª…, "ë³´ì¥ ë˜ë‚˜ìš”?"

2. ì œì§€ê¸‰
   ğŸ“ ë¬¸ì„œ ë‚´ìš©: ë³´í—˜ê¸ˆ ì§€ê¸‰ ì ˆì°¨, ì§€ê¸‰ ë°©ë²•(ê³„ì¢Œ/ë¶„í• ), ìˆ˜ìµì í™•ì¸, ì¼ë°˜ì ì¸ ì²­êµ¬ ì„œë¥˜ ì ‘ìˆ˜ ë°©ë²•, íœ´ë©´/ì¤‘ë„ë³´í—˜ê¸ˆ
   âœ… ë‹µë³€ ê°€ëŠ¥: "ì§€ê¸‰ ê³„ì¢Œ ë°”ê¾¸ë ¤ë©´?", "ë¶„í•  ì§€ê¸‰ ê°€ëŠ¥í•œê°€ìš”?", "ë¯¸ì„±ë…„ì ìˆ˜ìµì ì„œë¥˜ëŠ”?", "ì²­êµ¬ì„œë¥˜ ì ‘ìˆ˜ ë°©ë²•ì€?"
   âŒ ë‹µë³€ ë¶ˆê°€: "ì²­ì•½ì² íšŒ ê°€ëŠ¥í•œê°€ìš”?"(ê³„ì•½í•´ì§€), "ë°±ë‚´ì¥ ìˆ˜ìˆ  ë³´ì¥?"(ë³´í—˜ê¸ˆ ë³´ì¥), "ë³´í—˜ë£Œ ë‚©ì…?"(ë³´í—˜ë£Œë‚©ì…)
   âš ï¸ í•µì‹¬: "ì–´ë–»ê²Œ ë°›ë‚˜ìš”?", "ì ˆì°¨", "ë°©ë²•", "ê³„ì¢Œ", "ìˆ˜ìµì í™•ì¸" (ë‹¨, ì²­ì•½ì² íšŒëŠ” ì œì™¸)

3. ê³„ì•½ì •ë³´
   ğŸ“ ë¬¸ì„œ ë‚´ìš©: ê³„ì•½ ìƒíƒœ ì¡°íšŒ, ë¶€í™œ(ìë™/ì¼ë°˜), ê°ì•¡, ì‹¤íš¨, ì§ë¬´ì§ì¢… ë³€ê²½, **ê±´ê°•ì¸/ë¹„í¡ì—° í• ì¸ ì‹ ì²­**, ì›ë³¸ ì„œë¥˜(ì²­ì•½ì„œ)
   âœ… ë‹µë³€ ê°€ëŠ¥: "ìë™ë¶€í™œ ì¡°ê±´ì€?", "ì§€ê¸ˆ ë‚´ ê³„ì•½ì´ ì‹¤íš¨ ìƒíƒœì¸ê°€ìš”?", "ë¹„í¡ì—° í• ì¸ ì‹ ì²­í•˜ë ¤ë©´?", "ì²­ì•½ì„œ ì¬ë°œí–‰?"
   âŒ ë‹µë³€ ë¶ˆê°€: "ê±´ê°•í”ŒëŸ¬ìŠ¤ í• ì¸?"(í—¬ìŠ¤ì¼€ì–´ì„œë¹„ìŠ¤), "ë‹¨ìˆœ ì´ì²´ ê³„ì¢Œ ë³€ê²½?"(ë³´í—˜ë£Œë‚©ì…)
   âš ï¸ í•µì‹¬: "ë¶€í™œ", "ê°ì•¡", "ì‹¤íš¨", "ê³„ì•½ ë³€ê²½", "í• ì¸ ì‹ ì²­(ìƒí’ˆ ê¸°ëŠ¥)"

4. ë³´í—˜ë£Œë‚©ì…
   ğŸ“ ë¬¸ì„œ ë‚´ìš©: ë³´í—˜ë£Œ ë‚©ì… ìˆ˜ë‹¨(ìë™ì´ì²´, ì¹´ë“œ, ì†Œì•¡ê²°ì œ), ë‚©ì…ì¼/ì¶œê¸ˆì¼ ë³€ê²½, ë‚©ì…ì ë³€ê²½, ì¶”ê°€ë‚©ì…, ë‚©ì…ì¤‘ì§€
   âœ… ë‹µë³€ ê°€ëŠ¥: "ìë™ì´ì²´ì¼ ë³€ê²½í•˜ë ¤ë©´?", "ì¹´ë“œë¡œ ë³´í—˜ë£Œ ë‚¼ ìˆ˜ ìˆë‚˜ìš”?", "ë‚©ì…ì¤‘ì§€ ì‹ ì²­ ê°€ëŠ¥í•œê°€ìš”?"
   âŒ ë‹µë³€ ë¶ˆê°€: "ë‚©ì…ì£¼ê¸° ë³€ê²½?"(ê³„ì•½ì •ë³´ - ê³„ì•½ ì¡°ê±´ ë³€ê²½ì„)
   âš ï¸ í•µì‹¬: "ëˆì„ ë‚´ëŠ” ìˆ˜ë‹¨/ë°©ë²•", "ìë™ì´ì²´", "ì¹´ë“œ", "ì¶œê¸ˆ"

5. í—¬ìŠ¤ì¼€ì–´ì„œë¹„ìŠ¤
   ğŸ“ ë¬¸ì„œ ë‚´ìš©: ê±´ê°•ê²€ì§„ ì˜ˆì•½, í—¬ìŠ¤ì¼€ì–´ ì•±, ê±´ê°• ìƒë‹´, ìš´ë™/ì˜ì–‘ í”„ë¡œê·¸ë¨, ê±´ê°•í”ŒëŸ¬ìŠ¤ ì„œë¹„ìŠ¤
   âœ… ë‹µë³€ ê°€ëŠ¥: "ê±´ê°•ê²€ì§„ ì˜ˆì•½ ë°©ë²•?", "í—¬ìŠ¤ì¼€ì–´ ì•± ì„¤ì¹˜?", "ê±´ê°•í”ŒëŸ¬ìŠ¤ í• ì¸?"
   âŒ ë‹µë³€ ë¶ˆê°€: "ë¹„í¡ì—° í• ì¸ ì‹ ì²­?"(ê³„ì•½ì •ë³´), "ì•” ìˆ˜ìˆ ë¹„ ë³´ì¥?"(ë³´í—˜ê¸ˆ ë³´ì¥)
   âš ï¸ í•µì‹¬: ë³´í—˜ê¸ˆ/ê³„ì•½ê³¼ ë¬´ê´€í•œ 'ë¶€ê°€ ì„œë¹„ìŠ¤', ì•± ì‚¬ìš©ë²•

6. ëª…ì˜ë³€ê²½
   ğŸ“ ë¬¸ì„œ ë‚´ìš©: ê³„ì•½ì/ìˆ˜ìµì ë³€ê²½, ëª…ì˜ ì •ì •(ê°œëª…, ì£¼ë¯¼ë²ˆí˜¸), ì§€ì •ëŒ€ë¦¬ì²­êµ¬ì¸ ë“±ë¡
   âœ… ë‹µë³€ ê°€ëŠ¥: "ê³„ì•½ìë¥¼ ë‚¨í¸ìœ¼ë¡œ ë³€ê²½í•˜ë ¤ë©´?", "ìˆ˜ìµì ë³€ê²½ ì„œë¥˜?", "ì´ë¦„ì´ ë°”ë€Œì—ˆì–´ìš”"
   âš ï¸ í•µì‹¬: "ë³€ê²½", "ì •ì •", "ì§€ì •ëŒ€ë¦¬ì²­êµ¬ì¸"

7. ê³„ì•½í•´ì§€
   ğŸ“ ë¬¸ì„œ ë‚´ìš©: í•´ì§€/í•´ì•½ ì‹ ì²­, í•´ì§€í™˜ê¸‰ê¸ˆ ì¡°íšŒ/ìˆ˜ë ¹, ìœ„ì•½ê¸ˆ, **ì²­ì•½ì² íšŒ**
   âœ… ë‹µë³€ ê°€ëŠ¥: "ë³´í—˜ í•´ì§€í•˜ê³  ì‹¶ì–´ìš”", "í•´ì§€í™˜ê¸‰ê¸ˆ ì–¼ë§ˆì¸ê°€ìš”?", "ì²­ì•½ì² íšŒ ê¸°ê°„ì€?"
   âš ï¸ í•µì‹¬: "í•´ì§€", "í•´ì•½", "ì² íšŒ", "í™˜ê¸‰ê¸ˆ"

8. ì¦ëª…ì„œ ì•ˆë‚´ì¥
   ğŸ“ ë¬¸ì„œ ë‚´ìš©: ì†Œë“ê³µì œì¦ëª…ì„œ, ë‚©ì…ì¦ëª…ì„œ, ì¦ê¶Œ ì¬ë°œí–‰, ê°ì¢… ì•ˆë‚´ì¥ ë°œì†¡
   âœ… ë‹µë³€ ê°€ëŠ¥: "ì†Œë“ê³µì œì¦ëª…ì„œ ë°œê¸‰?", "ë³´í—˜ì¦ê¶Œ ì¬ë°œí–‰?"
   âŒ ë‹µë³€ ë¶ˆê°€: "ì²­ì•½ì„œ ì¬ë°œí–‰?"(ê³„ì•½ì •ë³´ - ì›ë³¸ ì„œë¥˜ì„)
   âš ï¸ í•µì‹¬: "ì¦ëª…ì„œ", "ë°œê¸‰", "ì¦ê¶Œ", "ì•ˆë‚´ì¥"

9. ë²• ì œë„
   ğŸ“ ë¬¸ì„œ ë‚´ìš©: ë¹„ê³¼ì„¸ ìš”ê±´, ì„¸ê¸ˆ ì œë„, ì„±ë…„í›„ê²¬, ì¬ì™¸êµ­ë¯¼, FATCA, ì†Œë©¸ì‹œíš¨, ìƒì† ë²•ê·œ
   âœ… ë‹µë³€ ê°€ëŠ¥: "ë¹„ê³¼ì„¸ ìš”ê±´ì´ ë­”ê°€ìš”?", "ì„±ë…„í›„ê²¬ì¸ ì§€ì • ì ˆì°¨?", "ì†Œë©¸ì‹œíš¨ê°€ ëª‡ ë…„ì¸ê°€ìš”?"
   âš ï¸ í•µì‹¬: "ë²•", "ì„¸ê¸ˆ(ì œë„)", "ìƒì†", "í›„ê²¬", "ì¬ì™¸êµ­ë¯¼"

10. ê³ ê°ì •ë³´
    ğŸ“ ë¬¸ì„œ ë‚´ìš©: ì£¼ì†Œ/ì—°ë½ì²˜ ë³€ê²½, ë§ˆì¼€íŒ… ë™ì˜/ì² íšŒ, ê°œì¸ì •ë³´ ì œê³µ
    âœ… ë‹µë³€ ê°€ëŠ¥: "ì´ì‚¬í•´ì„œ ì£¼ì†Œ ë°”ê¿”ì•¼ í•´ìš”", "ì „í™”ë²ˆí˜¸ ë³€ê²½?"
    âš ï¸ í•µì‹¬: "ì£¼ì†Œ", "ì „í™”ë²ˆí˜¸", "ê°œì¸ì •ë³´"

11. ëŒ€ì¶œ
    ğŸ“ ë¬¸ì„œ ë‚´ìš©: ë³´í—˜ê³„ì•½ëŒ€ì¶œ ì‹ ì²­/ìƒí™˜, ì´ììœ¨, ëŒ€ì¶œ í•œë„, APL(ìë™ëŒ€ì¶œë‚©ì…)
    âœ… ë‹µë³€ ê°€ëŠ¥: "ì•½ê´€ëŒ€ì¶œ ì–¼ë§ˆë‚˜ ê°€ëŠ¥í•œê°€ìš”?", "ëŒ€ì¶œ ì´ììœ¨ì€?", "APL ì‹ ì²­í•˜ë ¤ë©´?"
    âš ï¸ í•µì‹¬: "ëŒ€ì¶œ", "ìƒí™˜", "ì´ì", "APL"

12. ì—°ê¸ˆ
    ğŸ“ ë¬¸ì„œ ë‚´ìš©: ì—°ê¸ˆ ì „í™˜ ì‹ ì²­, ì—°ê¸ˆ ìˆ˜ë ¹ ë°©ë²•, ì—°ê¸ˆ ê°œì‹œ ë‚˜ì´
    âœ… ë‹µë³€ ê°€ëŠ¥: "ì—°ê¸ˆìœ¼ë¡œ ì „í™˜í•  ìˆ˜ ìˆë‚˜ìš”?", "ì—°ê¸ˆ ìˆ˜ë ¹ì•¡ì€ ì–¼ë§ˆ?"
    âš ï¸ í•µì‹¬: "ì—°ê¸ˆ"

13. ë³€ì•¡ í€ë“œ
    ğŸ“ ë¬¸ì„œ ë‚´ìš©: í€ë“œ ë³€ê²½, í€ë“œ ìˆ˜ìµë¥ , íˆ¬ì… ë¹„ìœ¨ ë³€ê²½, í€ë“œ ë¼ì¸ì—…
    âœ… ë‹µë³€ ê°€ëŠ¥: "í€ë“œ ë³€ê²½ ë°©ë²•?", "ìˆ˜ìµë¥  ì¢‹ì€ í€ë“œëŠ”?"
    âš ï¸ í•µì‹¬: "í€ë“œ", "ìˆ˜ìµë¥ ", "íˆ¬ì", "ë³€ì•¡"

14. ì±„ê¶Œì••ë¥˜ ì§ˆê¶Œì„¤ì •
    ğŸ“ ë¬¸ì„œ ë‚´ìš©: ë²•ì› ì••ë¥˜, ì§ˆê¶Œ ì„¤ì •, ì§€ê¸‰ ì •ì§€/í•´ì œ
    âœ… ë‹µë³€ ê°€ëŠ¥: "ì••ë¥˜ ë“¤ì–´ì™”ëŠ”ë° í•´ì§€í•˜ë ¤ë©´?", "ì§ˆê¶Œ ì„¤ì •ëœ ê³„ì•½ ëŒ€ì¶œ ë˜ë‚˜ìš”?"
    âš ï¸ í•µì‹¬: "ì••ë¥˜", "ì§ˆê¶Œ", "ë²•ì›", "ì§€ê¸‰ì •ì§€"

15. ë¶„ë¦¬ë³´ê´€
    ğŸ“ ë¬¸ì„œ ë‚´ìš©: íœ´ë©´ ê³„ì•½ì˜ ë¶„ë¦¬ ë³´ê´€, ë¶„ë¦¬ ë³´ê´€ëœ ê³„ì•½ ì¡°íšŒ
    âœ… ë‹µë³€ ê°€ëŠ¥: "ë¶„ë¦¬ë³´ê´€ ì•ˆë‚´ë¥¼ ë°›ì•˜ì–´ìš”", "ë¶„ë¦¬ë³´ê´€ëœ ê³„ì•½ ì°¾ê³  ì‹¶ì–´ìš”"
    âš ï¸ í•µì‹¬: "ë¶„ë¦¬ë³´ê´€"

16. ë¯¼ì›
    ğŸ“ ë¬¸ì„œ ë‚´ìš©: ë¯¼ì› ì ‘ìˆ˜ ì ˆì°¨, ë¶ˆë§Œ ì ‘ìˆ˜, ìœ„ë²•ê³„ì•½ í•´ì§€, í’ˆì§ˆë³´ì¦ í•´ì§€
    âœ… ë‹µë³€ ê°€ëŠ¥: "ë¶ˆë§Œ ì ‘ìˆ˜ ì–´ë””ì„œ í•˜ë‚˜ìš”?", "ìœ„ë²•ê³„ì•½ í•´ì§€í•˜ê³  ì‹¶ì–´ìš”", "í’ˆì§ˆë³´ì¦ í•´ì§€ ê¸°ê°„ì€?"
    âš ï¸ í•µì‹¬: "ë¯¼ì›", "ë¶ˆë§Œ", "ì´ì˜ ì œê¸°", "ìœ„ë²•ê³„ì•½", "í’ˆì§ˆë³´ì¦"

17. ì„¤ê³„ì‚¬
    ğŸ“ ë¬¸ì„œ ë‚´ìš©: ì„¤ê³„ì‚¬(MP) ì •ë³´, ìˆ˜ìˆ˜ë£Œ, ì´ê´€, ë‹´ë‹¹ì ë³€ê²½
    âœ… ë‹µë³€ ê°€ëŠ¥: "ë‹´ë‹¹ ì„¤ê³„ì‚¬ ì—°ë½ì²˜?", "ì„¤ê³„ì‚¬ ìˆ˜ìˆ˜ë£ŒëŠ” ì–´ë–»ê²Œ ë˜ë‚˜ìš”?"
    âš ï¸ í•µì‹¬: "ì„¤ê³„ì‚¬", "ëª¨ì§‘ì¸", "MP", "ë‹´ë‹¹ì"

18. ì‹ ê³„ì•½ ë¯¸ê²°
    ğŸ“ ë¬¸ì„œ ë‚´ìš©: ì²­ì•½ í›„ ìŠ¹ë‚™ ì „ ìƒíƒœ, ë°˜ì†¡/ë³´ì™„(M2), ë¶€ë‹´ë³´, ì¬ê³ ì§€, ì¸ìˆ˜ ì‹¬ì‚¬
    âœ… ë‹µë³€ ê°€ëŠ¥: "ì‹¬ì‚¬ ê²°ê³¼ ë‚˜ì™”ë‚˜ìš”?", "ë¶€ë‹´ë³´ ì¡í˜”ëŠ”ë° ë¬´ìŠ¨ ëœ»?", "ì¬ê³ ì§€ í•˜ë¼ê³  ì—°ë½ ì™”ì–´ìš”"
    âš ï¸ í•µì‹¬: "ì‹¬ì‚¬", "ì²­ì•½ ì¤‘", "ë¯¸ê²°", "ë³´ì™„", "ë¶€ë‹´ë³´", "ì¬ê³ ì§€"

19. ì±„ë„ í‘œê¸° ì½”ë“œ
    ğŸ“ ë¬¸ì„œ ë‚´ìš©: AIA+, ë³´ì´ëŠ” ARS, RTB, EWS, í‚¤ì˜¤ìŠ¤í¬ ì´ìš© ë°©ë²•, í†µì¥ í‘œê¸°(ì ìš”), ARS ë²ˆí˜¸ ì•ˆë‚´
    âœ… ë‹µë³€ ê°€ëŠ¥: "ì•± ë¡œê·¸ì¸ì´ ì•ˆ ë¼ìš”", "í†µì¥ì— AIA05ë¼ê³  ì°í˜”ëŠ”ë° ë­”ê°€ìš”?", "1588-XXXX ë²ˆí˜¸ í™•ì¸"
    âš ï¸ í•µì‹¬: "ì•±", "í™ˆí˜ì´ì§€", "ARS", "ì‹œìŠ¤í…œ", "ì˜¤ë¥˜", "ë¡œê·¸ì¸", "í†µì¥ í‘œê¸°"

20. ë°”ì´íƒˆë¦¬í‹°
    ğŸ“ ë¬¸ì„œ ë‚´ìš©: ë°”ì´íƒˆë¦¬í‹° ë©¤ë²„ì‹­, ë“±ê¸‰, ë¦¬ì›Œë“œ, íšŒë¹„, ì•± ì—°ë™
    âœ… ë‹µë³€ ê°€ëŠ¥: "ë°”ì´íƒˆë¦¬í‹° ë“±ê¸‰ ì–´ë–»ê²Œ ì˜¬ë¦¬ë‚˜ìš”?", "í†µì‹ ë¹„ í• ì¸?"
    âš ï¸ í•µì‹¬: "ë°”ì´íƒˆë¦¬í‹°", "ê±·ê¸°", "ë¦¬ì›Œë“œ"

21. í•´í”¼ì½œ
    ğŸ“ ë¬¸ì„œ ë‚´ìš©: ì™„ì „íŒë§¤ ëª¨ë‹ˆí„°ë§, í•´í”¼ì½œ ì „í™” ì¼ì •, í•´í”¼ì½œ ì§„í–‰ ë°©ë²•
    âœ… ë‹µë³€ ê°€ëŠ¥: "í•´í”¼ì½œ ì–¸ì œ ì˜¤ë‚˜ìš”?", "í•´í”¼ì½œ ëª» ë°›ì•˜ì–´ìš”"
    âš ï¸ í•µì‹¬: "í•´í”¼ì½œ", "ëª¨ë‹ˆí„°ë§"

=== ì˜ˆì‹œ (Thinking Process) ===

ì§ˆë¬¸ 1: "ì²­ì•½ì² íšŒë¥¼ ì´ë©”ì¼ë¡œ ì ‘ìˆ˜í•  ìˆ˜ ìˆë‚˜ìš”?"
ìƒê°:
1. [ê³„ì•½ ìƒíƒœ]ì™€ ê´€ë ¨ë¨. ê³„ì•½ì„ 'ëë‚´ëŠ”' ê²ƒì¸ê°€? -> Yes.
2. ì²­ì•½ì² íšŒëŠ” ê³„ì•½ì„ ë¬´íš¨í™”í•˜ëŠ” í–‰ìœ„ì´ë¯€ë¡œ [ê³„ì•½í•´ì§€]ì— ì†í•¨. (ì œì§€ê¸‰ ì•„ë‹˜)
ë„ë©”ì¸: ê³„ì•½í•´ì§€

ì§ˆë¬¸ 2: "ë‚©ì…ì£¼ê¸°ë¥¼ ì›”ë‚©ì—ì„œ ì—°ë‚©ìœ¼ë¡œ ë°”ê¾¸ê³  ì‹¶ì–´ìš”."
ìƒê°:
1. [ìê¸ˆ íë¦„]ê³¼ ê´€ë ¨ë˜ì§€ë§Œ, ëˆì„ ë‚´ëŠ” 'ë°©ë²•'ì´ ì•„ë‹ˆë¼ ê³„ì•½ì˜ 'ì¡°ê±´(ì£¼ê¸°)'ì„ ë°”ê¾¸ëŠ” ê²ƒì„.
2. [ê³„ì•½ ìƒíƒœ] ë³€ê²½ì— í•´ë‹¹í•˜ë¯€ë¡œ [ê³„ì•½ì •ë³´]ê°€ ì ì ˆí•¨.
ë„ë©”ì¸: ê³„ì•½ì •ë³´

ì§ˆë¬¸ 3: "ìë™ì´ì²´ ê³„ì¢Œë¥¼ ë°”ê¾¸ê³  ì‹¶ì–´ìš”."
ìƒê°:
1. [ìê¸ˆ íë¦„] ì¤‘ 'ëˆì„ ë‚´ëŠ”(ë‚©ì…)' ìˆ˜ë‹¨ì— ëŒ€í•œ ë³€ê²½ì„.
2. ê³„ì•½ ì¡°ê±´ ë³€ê²½ì´ ì•„ë‹ˆë¯€ë¡œ [ë³´í—˜ë£Œë‚©ì…]ì´ ì ì ˆí•¨.
ë„ë©”ì¸: ë³´í—˜ë£Œë‚©ì…

ì§ˆë¬¸ 4: "ì²­ì•½ì„œë¥¼ ìƒì–´ë²„ë ¸ëŠ”ë° ì¬ë°œí–‰ ê°€ëŠ¥í•œê°€ìš”?"
ìƒê°:
1. [ì„œë¥˜]ì™€ ê´€ë ¨ë¨. ì¦ëª…ì„œì¸ê°€? -> No. ê³„ì•½ ì›ë³¸ ì„œë¥˜ì„.
2. ê³„ì•½ ì›ë³¸ í™•ì¸ì€ [ê³„ì•½ì •ë³´]ì—ì„œ ê´€ë¦¬í•¨.
ë„ë©”ì¸: ê³„ì•½ì •ë³´

ì§ˆë¬¸ 5: "ë³´í—˜ê¸ˆ ì²­êµ¬ê¶Œ ì†Œë©¸ì‹œíš¨ëŠ” ì–¸ì œê¹Œì§€ì¸ê°€ìš”?"
ìƒê°:
1. [ì œë„/ê·œì •]ê³¼ ê´€ë ¨ë¨. ë²•ì ì¸ ê¸°ê°„(ì‹œíš¨)ì„ ë¬»ê³  ìˆìŒ.
2. íŠ¹ì • ìƒí’ˆì˜ ì¡°ê±´ì´ ì•„ë‹Œ ë²•ì  íš¨ë ¥ ê¸°ê°„ì´ë¯€ë¡œ [ë²• ì œë„]ì„.
ë„ë©”ì¸: ë²• ì œë„

=== ì˜ê²¬ êµ¬ë¶„ ì¹´í…Œê³ ë¦¬ ===
1. "ì •í™•íˆ ë¶„ë¥˜ë¨"
2. "Ground Truthê°€ ì˜ëª»ë¨"
3. "Questionì´ ëª¨í˜¸í•¨"
4. "ë§ëŠ” ë„ë©”ì¸ì´ ì—†ìŒ"
5. "ê¸°íƒ€ì˜ê²¬"

=== ì‘ë‹µ í˜•ì‹ ===
ë„ë©”ì¸: [ì„ íƒí•œ ë„ë©”ì¸]
ì´ìœ : [ë‹¨ê³„ë³„ íŒë‹¨ ê·¼ê±° ìš”ì•½]
ì˜ê²¬êµ¬ë¶„: [ìœ„ 5ê°€ì§€ ì¤‘ í•˜ë‚˜]
"""

        return prompt

    def _call_llm_api(self, prompt: str) -> Tuple[Optional[str], str]:
        """
        LLM API í˜¸ì¶œ (providerì— ë”°ë¼ ë‹¤ë¥¸ ë°©ì‹)

        Args:
            prompt: ì…ë ¥ í”„ë¡¬í”„íŠ¸

        Returns:
            (LLM ì‘ë‹µ í…ìŠ¤íŠ¸, ì˜¤ë¥˜ ë©”ì‹œì§€) íŠœí”Œ
        """
        if self.provider == "qwen3":
            return self._call_qwen3_api(prompt)
        elif self.provider == "databricks":
            return self._call_databricks_api(prompt)
        else:
            error_msg = f"ì§€ì›í•˜ì§€ ì•ŠëŠ” LLM provider: {self.provider}"
            logging.error("=" * 60)
            logging.error(f"ì§€ì›í•˜ì§€ ì•ŠëŠ” LLM provider")
            logging.error(f"ì„¤ì •ëœ Provider: {self.provider}")
            logging.error(f"ì§€ì› Provider: qwen3, databricks")
            logging.error("=" * 60)
            return None, error_msg

    def _call_qwen3_api(self, prompt: str) -> Tuple[Optional[str], str]:
        """
        Qwen3 API í˜¸ì¶œ

        Args:
            prompt: ì…ë ¥ í”„ë¡¬í”„íŠ¸

        Returns:
            (LLM ì‘ë‹µ í…ìŠ¤íŠ¸, ì˜¤ë¥˜ ë©”ì‹œì§€) íŠœí”Œ
        """
        endpoint = "ì•Œ ìˆ˜ ì—†ìŒ"  # ì˜¤ë¥˜ ë¡œê¹…ì„ ìœ„í•œ ê¸°ë³¸ê°’
        try:
            host = self.config.get("host")
            port = self.config.get("port")
            model = self.config.get("model")

            endpoint = f"http://{host}:{port}/v1/chat/completions"

            payload = {
                "model": model,
                "messages": [{"role": "user", "content": prompt}],
                "temperature": 0.3,
                "max_tokens": 1000,
            }

            headers = {"Content-Type": "application/json"}

            response = self.session.post(
                endpoint, headers=headers, json=payload, timeout=self.timeout
            )

            if response.status_code == 200:
                result = response.json()
                if "choices" in result and len(result["choices"]) > 0:
                    content = result["choices"][0]["message"]["content"]

                    # ë¹ˆ ë¬¸ìì—´ í™•ì¸
                    if not content or not content.strip():
                        error_msg = "ë¹ˆ ì‘ë‹µ ë‚´ìš©"
                        logging.error("=" * 60)
                        logging.error(f"Qwen3 API - {error_msg}")
                        logging.error(f"Endpoint: {endpoint}")
                        logging.debug(f"ì‘ë‹µ ë‚´ìš©: {result}")
                        logging.error("=" * 60)
                        return None, error_msg

                    logging.debug(f"Qwen3 API ì‘ë‹µ ì„±ê³µ: {content[:100]}...")
                    return content, ""
                else:
                    error_msg = f"ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ í˜•ì‹"
                    logging.error("=" * 60)
                    logging.error(f"Qwen3 API - {error_msg}")
                    logging.error(f"Endpoint: {endpoint}")
                    logging.debug(f"ì‘ë‹µ ë‚´ìš©: {result}")
                    logging.error("=" * 60)
                    return None, error_msg
            else:
                error_msg = f"HTTP {response.status_code} ì˜¤ë¥˜"
                logging.error("=" * 60)
                logging.error("Qwen3 API í˜¸ì¶œ ì‹¤íŒ¨")
                logging.error(f"Endpoint: {endpoint}")
                logging.error(f"Status Code: {response.status_code}")
                logging.debug(f"Response Headers: {dict(response.headers)}")
                logging.debug(f"Response Body: {response.text}")
                logging.error("=" * 60)
                return None, error_msg

        except requests.exceptions.Timeout:
            error_msg = f"API í˜¸ì¶œ íƒ€ì„ì•„ì›ƒ ({self.timeout}ì´ˆ)"
            logging.error("=" * 60)
            logging.error(f"Qwen3 {error_msg}")
            logging.error(f"Endpoint: {endpoint}")
            logging.error("=" * 60)
            return None, error_msg
        except requests.exceptions.ConnectionError as e:
            error_msg = f"ì„œë²„ ì—°ê²° ì‹¤íŒ¨: {str(e)}"
            logging.error("=" * 60)
            logging.error(f"Qwen3 ì„œë²„ ì—°ê²° ì‹¤íŒ¨")
            logging.error(f"Endpoint: {endpoint}")
            logging.error(f"ì˜¤ë¥˜ ë©”ì‹œì§€: {str(e)}")
            logging.error("=" * 60)
            return None, error_msg
        except Exception as e:
            error_msg = f"ì˜ˆì™¸ ë°œìƒ: {str(e)}"
            logging.error("=" * 60)
            logging.error(f"Qwen3 API í˜¸ì¶œ ì¤‘ ì˜ˆì™¸ ë°œìƒ")
            logging.error(f"Endpoint: {endpoint}")
            logging.error(f"ì˜¤ë¥˜ ë©”ì‹œì§€: {str(e)}")
            import traceback

            logging.debug(f"ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:\n{traceback.format_exc()}")
            logging.error("=" * 60)
            return None, error_msg

    def _call_databricks_api(self, prompt: str) -> Tuple[Optional[str], str]:
        """
        Databricks API í˜¸ì¶œ

        Args:
            prompt: ì…ë ¥ í”„ë¡¬í”„íŠ¸

        Returns:
            (LLM ì‘ë‹µ í…ìŠ¤íŠ¸, ì˜¤ë¥˜ ë©”ì‹œì§€) íŠœí”Œ
        """
        url = "ì•Œ ìˆ˜ ì—†ìŒ"  # ì˜¤ë¥˜ ë¡œê¹…ì„ ìœ„í•œ ê¸°ë³¸ê°’
        try:
            url = self.config.get("url", "ì•Œ ìˆ˜ ì—†ìŒ")
            token = self.config.get("token")

            payload = {
                "messages": [{"role": "user", "content": prompt}],
                "temperature": 0.3,
                "max_tokens": 3000,
            }

            headers = {
                "Authorization": f"Bearer {token}",
                "Content-Type": "application/json",
            }

            response = self.session.post(
                url, headers=headers, json=payload, timeout=self.timeout
            )

            if response.status_code == 200:
                result = response.json()
                if "choices" in result and len(result["choices"]) > 0:
                    content = result["choices"][0]["message"]["content"]

                    # contentê°€ ë¦¬ìŠ¤íŠ¸ì¸ ê²½ìš° ì²˜ë¦¬ (Databricks API íŠ¹ì„±)
                    if isinstance(content, list):
                        # ë¹ˆ ë¦¬ìŠ¤íŠ¸ í™•ì¸
                        if not content:
                            error_msg = "ë¹ˆ ì‘ë‹µ ë¦¬ìŠ¤íŠ¸"
                            logging.error("=" * 60)
                            logging.error(f"Databricks API - {error_msg}")
                            logging.error(f"URL: {url}")
                            logging.debug(f"ì‘ë‹µ ë‚´ìš©: {result}")
                            logging.error("=" * 60)
                            return None, error_msg

                        # ë¦¬ìŠ¤íŠ¸ì˜ ê° ìš”ì†Œë¥¼ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜í•˜ì—¬ ê²°í•©
                        text_parts = []
                        for item in content:
                            if isinstance(item, dict):
                                # 'reasoning' íƒ€ì… ì²˜ë¦¬ (nested summary)
                                if (
                                    item.get("type") == "reasoning"
                                    and "summary" in item
                                ):
                                    for summary_item in item["summary"]:
                                        if (
                                            isinstance(summary_item, dict)
                                            and "text" in summary_item
                                        ):
                                            text_parts.append(summary_item["text"])
                                # ì¼ë°˜ 'text' í•„ë“œ
                                elif "text" in item:
                                    text_parts.append(item["text"])
                            elif isinstance(item, str):
                                text_parts.append(item)
                        content = "\n".join(text_parts)

                    # ë¹ˆ ë¬¸ìì—´ í™•ì¸
                    if not content or not content.strip():
                        error_msg = "ë¹ˆ ì‘ë‹µ ë‚´ìš©"
                        logging.error("=" * 60)
                        logging.error(f"Databricks API - {error_msg}")
                        logging.error(f"URL: {url}")
                        logging.debug(f"ì‘ë‹µ ë‚´ìš©: {result}")
                        logging.error("=" * 60)
                        return None, error_msg

                    logging.debug(f"Databricks API ì‘ë‹µ ì„±ê³µ: {content[:100]}...")
                    return content, ""
                else:
                    error_msg = f"ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ í˜•ì‹"
                    logging.error("=" * 60)
                    logging.error(f"Databricks API - {error_msg}")
                    logging.error(f"URL: {url}")
                    logging.debug(f"ì‘ë‹µ ë‚´ìš©: {result}")
                    logging.error("=" * 60)
                    return None, error_msg
            else:
                error_msg = f"HTTP {response.status_code} ì˜¤ë¥˜"
                logging.error("=" * 60)
                logging.error("Databricks API í˜¸ì¶œ ì‹¤íŒ¨")
                logging.error(f"URL: {url}")
                logging.error(f"Status Code: {response.status_code}")
                logging.debug(f"Response Headers: {dict(response.headers)}")
                logging.debug(f"Response Body: {response.text}")
                logging.error("=" * 60)
                return None, error_msg

        except requests.exceptions.Timeout:
            error_msg = f"API í˜¸ì¶œ íƒ€ì„ì•„ì›ƒ ({self.timeout}ì´ˆ)"
            logging.error("=" * 60)
            logging.error(f"Databricks {error_msg}")
            logging.error(f"URL: {url}")
            logging.error("=" * 60)
            return None, error_msg
        except requests.exceptions.ConnectionError as e:
            error_msg = f"ì„œë²„ ì—°ê²° ì‹¤íŒ¨: {str(e)}"
            logging.error("=" * 60)
            logging.error(f"Databricks ì„œë²„ ì—°ê²° ì‹¤íŒ¨")
            logging.error(f"URL: {url}")
            logging.error(f"ì˜¤ë¥˜ ë©”ì‹œì§€: {str(e)}")
            logging.error("=" * 60)
            return None, error_msg
        except Exception as e:
            error_msg = f"ì˜ˆì™¸ ë°œìƒ: {str(e)}"
            logging.error("=" * 60)
            logging.error(f"Databricks API í˜¸ì¶œ ì¤‘ ì˜ˆì™¸ ë°œìƒ")
            logging.error(f"URL: {url}")
            logging.error(f"ì˜¤ë¥˜ ë©”ì‹œì§€: {str(e)}")
            import traceback

            logging.debug(f"ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:\n{traceback.format_exc()}")
            logging.error("=" * 60)
            return None, error_msg

    def _parse_response(self, response: str) -> Tuple[Optional[str], str, str]:
        """
        LLM ì‘ë‹µ íŒŒì‹±

        Args:
            response: LLM ì‘ë‹µ í…ìŠ¤íŠ¸

        Returns:
            (ë„ë©”ì¸, ì˜ê²¬, ì˜ê²¬êµ¬ë¶„) íŠœí”Œ
        """
        try:
            domain = None
            opinion = ""
            opinion_category = "ê¸°íƒ€ì˜ê²¬"

            # responseê°€ ë¬¸ìì—´ì´ ì•„ë‹Œ ê²½ìš° ì²˜ë¦¬
            if not isinstance(response, str):
                logging.warning("=" * 60)
                logging.warning(f"LLM ì‘ë‹µì´ ë¬¸ìì—´ì´ ì•„ë‹™ë‹ˆë‹¤")
                logging.warning(f"ì‘ë‹µ íƒ€ì…: {type(response)}")
                logging.debug(f"ì‘ë‹µ ê°’: {response}")
                logging.warning("ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ì²˜ë¦¬ë¥¼ ê³„ì†í•©ë‹ˆë‹¤.")
                logging.warning("=" * 60)
                response = str(response)

            # LLM ì‘ë‹µ ì „ì²´ (DEBUG ëª¨ë“œì—ì„œë§Œ)
            logging.debug(f"LLM ì‘ë‹µ íŒŒì‹± ì‹œì‘:")
            logging.debug(f"ì‘ë‹µ ë‚´ìš©: {response}")

            # ì˜ê²¬ êµ¬ë¶„ ì¹´í…Œê³ ë¦¬ ëª©ë¡
            valid_categories = [
                "ì •í™•íˆ ë¶„ë¥˜ë¨",
                "Ground Truthê°€ ì˜ëª»ë¨",
                "Questionì´ ëª¨í˜¸í•¨",
                "ë§ëŠ” ë„ë©”ì¸ì´ ì—†ìŒ",
                "ê¸°íƒ€ì˜ê²¬",
            ]

            lines = response.strip().split("\n")

            # ê³„ì¸µì  ë„ë©”ì¸ ëª¨ë“œ ë³€ìˆ˜
            hierarchical_domain = None
            detail_domain = None

            for line in lines:
                line = line.strip()

                # ê³„ì¸µì  ë„ë©”ì¸ ëª¨ë“œ
                if self.use_hierarchical_domains:
                    if line.startswith("ìƒìœ„ë„ë©”ì¸:"):
                        hierarchical_domain = line.replace("ìƒìœ„ë„ë©”ì¸:", "").strip()
                    elif line.startswith("ì„¸ë¶€ë„ë©”ì¸:"):
                        detail_domain_text = line.replace("ì„¸ë¶€ë„ë©”ì¸:", "").strip()
                        # ë„ë©”ì¸ ëª©ë¡ì—ì„œ ë§¤ì¹­ë˜ëŠ” ê²ƒ ì°¾ê¸°
                        for d in self.domains:
                            if d in detail_domain_text:
                                detail_domain = d
                                break
                        if not detail_domain:
                            detail_domain = detail_domain_text

                # ê¸°ì¡´ ë°©ì‹
                else:
                    if line.startswith("ë„ë©”ì¸:"):
                        domain_text = line.replace("ë„ë©”ì¸:", "").strip()
                        # ë„ë©”ì¸ ëª©ë¡ì—ì„œ ë§¤ì¹­ë˜ëŠ” ê²ƒ ì°¾ê¸°
                        for d in self.domains:
                            if d in domain_text:
                                domain = d
                                break
                        if not domain:
                            domain = domain_text

                # ê³µí†µ í•„ë“œ
                if line.startswith("ì´ìœ :"):
                    opinion = line.replace("ì´ìœ :", "").strip()

                elif line.startswith("ì˜ê²¬êµ¬ë¶„:"):
                    category_text = line.replace("ì˜ê²¬êµ¬ë¶„:", "").strip()
                    # ì˜ê²¬ êµ¬ë¶„ ì¹´í…Œê³ ë¦¬ ë§¤ì¹­
                    for cat in valid_categories:
                        if cat in category_text:
                            opinion_category = cat
                            break

            # ê³„ì¸µì  ë„ë©”ì¸ ëª¨ë“œ: ì„¸ë¶€ ë„ë©”ì¸ì„ ìµœì¢… ë„ë©”ì¸ìœ¼ë¡œ ì„¤ì •
            if self.use_hierarchical_domains:
                domain = detail_domain
                # ì˜ê²¬ì— ìƒìœ„ ë„ë©”ì¸ ì •ë³´ ì¶”ê°€
                if hierarchical_domain and detail_domain:
                    opinion = f"[{hierarchical_domain}] {opinion}"

            # ì˜ê²¬ì´ ì—†ìœ¼ë©´ ì „ì²´ ì‘ë‹µì„ ì˜ê²¬ìœ¼ë¡œ ì‚¬ìš©
            if not opinion:
                opinion = response.strip()

            # ë„ë©”ì¸ì´ íŒŒì‹±ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë„ë©”ì¸ ëª©ë¡ì—ì„œ ì²« ë²ˆì§¸ë¡œ ë°œê²¬ë˜ëŠ” ê²ƒ ì‚¬ìš©
            if not domain:
                for d in self.domains:
                    if d in response:
                        domain = d
                        break

            # ê·¸ë˜ë„ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ë„ë©”ì¸ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ
            if not domain:
                domain = self.domains[0] if self.domains else "ë¯¸ë¶„ë¥˜"
                opinion = f"ë„ë©”ì¸ íŒŒì‹± ì‹¤íŒ¨. ì›ë³¸ ì‘ë‹µ: {response}"

            return domain, opinion, opinion_category

        except Exception as e:
            logging.error("=" * 60)
            logging.error(f"ì‘ë‹µ íŒŒì‹± ì¤‘ ì˜ˆì™¸ ë°œìƒ")
            logging.debug(f"ì‘ë‹µ ë‚´ìš©: {response}")
            logging.error(f"ì˜¤ë¥˜ ë©”ì‹œì§€: {str(e)}")
            import traceback

            logging.debug(f"ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:\n{traceback.format_exc()}")
            logging.error("=" * 60)
            return (
                self.domains[0] if self.domains else "ë¯¸ë¶„ë¥˜",
                f"íŒŒì‹± ì˜¤ë¥˜: {str(e)}",
                "ê¸°íƒ€ì˜ê²¬",
            )

    def close(self):
        """Session ê°ì²´ ì •ë¦¬"""
        if self.session:
            self.session.close()
